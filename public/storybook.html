<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTRPG UI Storybook</title>
    <!-- React UMD -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-neutral-950 text-neutral-100 min-h-screen">
    <div id="root"></div>
    <div id="test-output" class="max-w-xl mx-auto p-4 text-xs text-white/70"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useRef, useEffect } = React;
      const btn = "inline-flex items-center justify-center px-2 py-1 rounded bg-white/10 hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/30 active:bg-white/30 cursor-pointer border border-white/20";
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      function filterOptions(options, input){
        const needle = String(input||'').toLowerCase();
        return options.filter(o => String(o).toLowerCase().includes(needle));
      }

      // --- HP BAR ------------------------------------------------------------
      function HPBar({ current, temp, max, onChange }){
        const pct = clamp((current/Math.max(1,max))*100, 0, 100);
        const tempPct = clamp(((temp)/Math.max(1,max))*100, 0, 100);
        return (
          <div className="p-3 bg-white/5 rounded-xl border border-white/10">
            <div className="flex justify-between mb-2 text-sm">
              <span className="font-medium">HP</span>
              <span className="tabular-nums">{current}{temp?` (+${temp})`:''} / {max}</span>
            </div>
            <div className="relative w-full h-4 rounded overflow-hidden bg-neutral-800">
              <div className="absolute inset-y-0 left-0 bg-blue-500/30" style={{width: `${clamp((current+temp)/Math.max(1,max)*100,0,100)}%`}} />
              <div className="absolute inset-y-0 left-0 bg-red-500" style={{width: `${pct}%`}} />
            </div>
            <div className="flex flex-wrap items-center gap-2 mt-3 text-xs">
              <div className="flex gap-1">
                <button className={btn} onClick={()=>onChange({current: clamp(current-1,0,max)})}>‚àí HP</button>
                <button className={btn} onClick={()=>onChange({current: clamp(current+1,0,max)})}>+ HP</button>
              </div>
              <div className="flex gap-1">
                <button className={btn+" bg-blue-500/20 hover:bg-blue-500/30 focus:ring-blue-400/40"} onClick={()=>onChange({temp: Math.max(0,temp-1)})}>‚àí Temp</button>
                <button className={btn+" bg-blue-500/20 hover:bg-blue-500/30 focus:ring-blue-400/40"} onClick={()=>onChange({temp: temp+1})}>+ Temp</button>
              </div>
              <div className="flex gap-1">
                <button className={btn} onClick={()=>onChange({max: Math.max(1,max-1), current: clamp(current,0,Math.max(1,max-1))})}>‚àí Max</button>
                <button className={btn} onClick={()=>onChange({max: max+1})}>+ Max</button>
              </div>
            </div>
          </div>
        );
      }

      // --- STAT TRACKER -----------------------------------------------------
      function StatTracker({ name='STR', value, onChange, onRoll, onLongRoll, onInfo }){
        const hold = useRef(null);
        const start = ()=>{ hold.current = setTimeout(()=>{ hold.current=null; onLongRoll && onLongRoll(); }, 500); };
        const end = ()=>{ if (hold.current){ clearTimeout(hold.current); hold.current=null; onRoll && onRoll(); } };
        return (
          <div className="p-3 bg-white/5 rounded-xl border border-white/10 flex items-center justify-between">
            {onInfo && (
              <button onClick={onInfo}
                className="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 cursor-pointer mr-2 focus:outline-none focus:ring-2 focus:ring-white/30"
                title="More info">‚ÑπÔ∏è</button>
            )}
            <div className="flex-1 text-center">
              <div className="text-xs uppercase opacity-75 tracking-wide">{name}</div>
              <div className="flex items-center justify-center gap-1 mt-1">
                <button className={btn} onClick={()=>onChange(value-1)}>‚àí</button>
                <div className="w-10 text-center tabular-nums select-none">{value}</div>
                <button className={btn} onClick={()=>onChange(value+1)}>+</button>
              </div>
            </div>
            <button
              onMouseDown={start} onMouseUp={end}
              onTouchStart={start} onTouchEnd={end}
              className={btn+" ml-2 px-3"}
            >üé≤<span className="ml-1 text-xs italic text-white/60">hold</span></button>
          </div>
        );
      }

      // --- ComboField (free text + suggestions) ----------------------------
      function ComboField({ label, options = [], value, onChange, placeholder = 'Type or select‚Ä¶' }){
        const [open, setOpen] = useState(false);
        const [input, setInput] = useState(value || '');
        const [hi, setHi] = useState(-1);
        const boxRef = useRef(null);
        useEffect(()=>{ setInput(value || ''); }, [value]);
        const filtered = filterOptions(options, input);
        useEffect(()=>{
          function onDocClick(e){ if (!boxRef.current) return; if (!boxRef.current.contains(e.target)) setOpen(false); }
          document.addEventListener('mousedown', onDocClick);
          return ()=> document.removeEventListener('mousedown', onDocClick);
        }, []);
        function commit(val){ onChange && onChange(val); setInput(val); setOpen(false); setHi(-1); }
        function onKey(e){
          if (e.key==='ArrowDown'){ e.preventDefault(); setOpen(true); setHi(i=> Math.min((i<0?-1:i)+1, filtered.length-1)); }
          else if (e.key==='ArrowUp'){ e.preventDefault(); setHi(i=> Math.max(i-1,0)); }
          else if (e.key==='Enter'){ e.preventDefault(); commit(filtered[hi] ?? input); }
          else if (e.key==='Escape'){ setOpen(false); setHi(-1); }
        }
        return (
          <div className="w-full" ref={boxRef}>
            {label && <label className="block text-xs uppercase tracking-wide opacity-75 mb-1">{label}</label>}
            <div className="relative">
              <input className="w-full bg-black/20 border border-white/10 rounded-xl px-3 py-2 pr-8 outline-none focus:border-white/30"
                placeholder={placeholder}
                value={input}
                onChange={(e)=>{ setInput(e.target.value); setOpen(true); setHi(-1); onChange && onChange(e.target.value); }}
                onFocus={()=> setOpen(true)}
                onKeyDown={onKey}
              />
              <button type="button" className="absolute right-1 top-1/2 -translate-y-1/2 text-xs px-2 py-1 bg-white/10 hover:bg-white/20 rounded"
                onClick={()=> setOpen(o=>!o)} aria-label="Toggle options">‚ñæ</button>
              {open && (
                <div className="absolute z-10 mt-1 w-full max-h-56 overflow-auto bg-neutral-900 border border-white/10 rounded-xl shadow-lg">
                  {filtered.length===0 && (<div className="px-3 py-2 text-sm opacity-70">No matches. Press Enter to use "{input}"</div>)}
                  {filtered.map((opt, idx)=> (
                    <button key={opt} type="button" className={`w-full text-left px-3 py-2 text-sm hover:bg-white/10 ${idx===hi?'bg-white/10':''}`}
                      onMouseEnter={()=> setHi(idx)}
                      onMouseDown={(e)=> e.preventDefault()}
                      onClick={()=> commit(opt)}>{opt}</button>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      }

      // --- Inventory & Drag/Drop -------------------------------------------
      function InventoryItem({ item, isDragging, handleProps, onIncrease, onDecrease }){
        return (
          <div className={`p-2 bg-white/5 rounded-xl border border-white/10 mb-1 flex justify-between items-center transition-opacity ${isDragging?'opacity-0':''}`}>
            <div className="flex items-center gap-2">
              <span {...handleProps} className="cursor-grab select-none" title="Drag" draggable>‚ò∞</span>
              <span className="font-medium">{item.name}</span>
            </div>
            <div className="flex items-center gap-1">
              <button className={btn} onClick={()=> onDecrease(item.id)} aria-label="Decrease quantity">‚àí</button>
              <span className="tabular-nums min-w-[3ch] text-center">x{item.amount}</span>
              <button className={btn} onClick={()=> onIncrease(item.id)} aria-label="Increase quantity">+</button>
            </div>
          </div>
        );
      }

      function Inventory({ items, onIncrease, onDecrease, onReorder }){
        const [dragIndex, setDragIndex] = useState(null);
        const [overIndex, setOverIndex] = useState(null);
        const containerRef = useRef(null);

        function reorder(from, to){
          if (from==null || to==null || from===to) return;
          const next = items.slice();
          const [m] = next.splice(from,1);
          // allow dropping after last item
          const insertAt = Math.min(to, next.length);
          next.splice(insertAt, 0, m);
          onReorder && onReorder(next);
        }
        function onHandleDragStart(e, idx){
          setDragIndex(idx); setOverIndex(idx);
          if (e.dataTransfer && e.dataTransfer.setDragImage){
            const img = new Image(); img.src='data:image/png;base64,iVBORw0KGgo='; e.dataTransfer.setDragImage(img,0,0);
          }
        }
        function onRowDragOver(e, idx){
          e.preventDefault(); setOverIndex(idx);
          const el = containerRef.current; if (!el) return; const rect = el.getBoundingClientRect(); const y = e.clientY; const zone = 32;
          if (y < rect.top + zone) el.scrollTop -= 12; else if (y > rect.bottom - zone) el.scrollTop += 12;
        }
        function onDrop(){ reorder(dragIndex, overIndex); setDragIndex(null); setOverIndex(null); }
        function onDragEnd(){ setDragIndex(null); setOverIndex(null); }

        return (
          <div>
            <h2 className="text-lg font-semibold mb-2">Inventory</h2>
            <div ref={containerRef} className="max-h-80 overflow-auto">
              {items.map((it, idx)=> (
                <div key={it.id} onDragOver={(e)=> onRowDragOver(e, idx)} onDrop={onDrop}>
                  <InventoryItem
                    item={it}
                    isDragging={dragIndex===idx}
                    onIncrease={onIncrease}
                    onDecrease={onDecrease}
                    handleProps={{ onDragStart:(e)=> onHandleDragStart(e, idx), onDragEnd }}
                  />
                </div>
              ))}
              {/* end drop zone to place at end */}
              <div className="h-6" onDragOver={(e)=>{ e.preventDefault(); setOverIndex(items.length); }} onDrop={onDrop} />
            </div>
          </div>
        );
      }

      // --- App --------------------------------------------------------------
      function App(){
        // HP + Stat
        const [hp, setHp] = useState({ current: 24, temp: 3, max: 30 });
        const [str, setStr] = useState(3);
        // Identity
        const CLASS_OPTIONS = ['Barbarian','Bard','Cleric','Druid','Fighter','Monk','Paladin','Ranger','Rogue','Sorcerer','Warlock','Wizard'];
        const RACE_OPTIONS = ['Human','Elf','Dwarf','Halfling','Gnome','Half-Elf','Half-Orc','Tiefling','Dragonborn'];
        const [charClass, setCharClass] = useState('Fighter');
        const [race, setRace] = useState('Human');
        // Inventory
        const [items, setItems] = useState([
          { id: 1, name: 'Torch', amount: 2 },
          { id: 2, name: 'Rope', amount: 1 },
          { id: 3, name: 'Potion', amount: 3 },
        ]);
        const updateItemAmount = (id, delta)=> setItems(prev => prev.map(it => it.id===id ? { ...it, amount: Math.max(0, it.amount + delta) } : it));

        return (
          <div className="max-w-2xl mx-auto p-6 space-y-6">
            <h1 className="text-2xl font-bold">TTRPG UI Storybook</h1>

            <section>
              <h2 className="text-lg font-semibold mb-2">HP Bar</h2>
              <HPBar {...hp} onChange={(changes)=> setHp(prev=> ({...prev, ...changes}))} />
            </section>

            <section>
              <h2 className="text-lg font-semibold mb-2">Stats</h2>
              <StatTracker name="STR" value={str} onChange={setStr} onRoll={()=>alert(`Roll STR +${str}`)} onLongRoll={()=>alert(`Long roll STR +${str}`)} onInfo={()=>alert('Strength: melee, checks, carry.')} />
            </section>

            <section>
              <h2 className="text-lg font-semibold mb-2">Identity</h2>
              <div className="grid sm:grid-cols-2 gap-3">
                <ComboField label="Class" options={CLASS_OPTIONS} value={charClass} onChange={setCharClass} />
                <ComboField label="Race" options={RACE_OPTIONS} value={race} onChange={setRace} />
              </div>
              <div className="mt-2 text-sm opacity-70">Selected: {charClass || '‚Äî'} / {race || '‚Äî'}</div>
            </section>

            <section>
              <Inventory
                items={items}
                onIncrease={(id)=> updateItemAmount(id, +1)}
                onDecrease={(id)=> updateItemAmount(id, -1)}
                onReorder={(next)=> setItems(next)}
              />
            </section>
          </div>
        );
      }

      // --- Mount (createRoot fallback) -------------------------------------
      (function mount(){
        const node = document.getElementById('root');
        if (!node) return console.error('Missing #root element');
        if (ReactDOM.createRoot) { ReactDOM.createRoot(node).render(<App />); }
        else if (ReactDOM.render) { ReactDOM.render(<App />, node); }
        else { console.error('No compatible React DOM renderer found'); }
      })();

      // --- Lightweight tests ----------------------------------------------
      (function runTests(){
        const out = [];
        const eq = (a,b)=> JSON.stringify(a)===JSON.stringify(b);
        function assert(msg, cond){ out.push(`${cond ? '‚úÖ' : '‚ùå'} ${msg}`); }
        assert('#root exists', !!document.getElementById('root'));
        // filterOptions
        assert('filterOptions finds Fighter by "fi"', filterOptions(['Fighter','Wizard'],'fi')[0]==='Fighter');
        assert('filterOptions empty returns all', filterOptions(['A','B','C'],'').length===3);
        assert('filterOptions no match returns []', filterOptions(['A'],'zzz').length===0);
        // reorder pure check (drop to end)
        (function(){ const arr=[1,2,3]; const from=0,to=3; const next=arr.slice(); const [m]=next.splice(from,1); next.splice(Math.min(to,next.length),0,m); assert('reorder to end works', eq(next,[2,3,1])); })();
        // hp clamp
        assert('hp clamp not below 0', clamp(-5,0,10)===0);
        document.getElementById('test-output').textContent = out.join('\n');
      })();
    </script>
  </body>
</html>
